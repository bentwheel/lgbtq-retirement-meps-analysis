---
title: "Comparing and Contrasting Individual Healthcare Expenditures among Subpopulations of LGBTQ+ Individuals Over Age 65"

author: C. Seth Lester, ASA, MAAA (<a href="mailto:seth.lester@milliman.com">seth.lester@milliman.com</a>)<br>
date: 30 May 2023
#output: github_document
output: word_document
---

```{r Initial_Setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)

# This chunk consists of all package installs and other environment setup considerations that should be run only once. The use of if statements below ensures that packages which are already installed are not re-installed - however, if you have a very old version of these packages, you might need to reinstall with a newer version.

# Install packages from source.

# Specific source versions are specified in order to maintain compatibility with the code 
# in this project. Please note that running the following lines of code 

# Invoke required libraries - install them in the User package library if not already installed.
if(!require(devtools)) { install.packages("devtools"); library(devtools) }
if(!require(survey)) { install.packages("survey"); library(survey) }
if(!require(foreign)) { install.packages("foreign"); library(foreign) }
if(!require(haven)) { install.packages("haven"); library(haven) }
if(!require(tidyverse)) { install.packages("tidyverse"); library(tidyverse) }
if(!require(kableExtra)) { install.packages("kableExtra"); library(kableExtra) }
if(!require(scales)) { install.packages("scales"); library(scales) }
if(!require(here)) { install.packages("here"); library(here) }

# Use devtools to download custom MEPS dataset interface package from Github if it is not already installed.
# Fore more information on the MEPS package and how to use it, refer to the following URL:
# https://github.com/HHS-AHRQ/MEPS/tree/master/R#all-data-years-using-the-meps-package
if(!require(MEPS)) { devtools::install_github("e-mitchell/meps_r_pkg/MEPS") }

```
_The following paper is a submission in reply to the [Society of Actuaries' Call for Papers](https://www.soa.org/research/opportunities/call-for-papers-list/) under the heading "[Aging and Retirement Issues for LGBTQ+ People – Second Invitation](https://www.soa.org/research/opportunities/call-for-essay-aging-retire-lgbtq/)"._

For many years, people who identify as LGBTQ+ have endured discrimination from a wide variety of sources, such as from laws and regulations at all levels of government, or as a result of the ebb and flow of occupational attitudes over time, and even from members in our own community. 

For some LGBTQ+-identifying subpopulations, the level of discrimination we face in society is rapidly waning; for others, such as transgender individuals, there are still impactful and endemic stigmas in play which act as a barrier to these individuals from living full and rewarding lives. Barriers such as these have likely inhibited the ability of many people who identify as LGBTQ+ from enjoying the same protections of our social safety net – such as healthcare and retirement security systems – that are enjoyed by non-LGBTQ+-identifying people.

It is difficult today for analysts to credibly estimate how retirement-related outcomes differ between LGBTQ+ and non-LGBTQ+ populations, or how to quantify the disparities of outcomes among intersectional subpopulations that exist today within LGBTQ+ communities. One primary reason motivating this difficulty stems from the lack of available data that can help guide our policymaking apparatus towards better regulations and protections for members of our society who are more likely to be marginalized, stigmatized, or disadvantaged by systemic factors. This includes LGBTQ+ people, of course, but heavily intersects with people of color, women, religious minorities, immigrants, disabled individuals, and countless other populations of interest that comprise the greater whole of the nation.

In the healthcare space, there is ample energy surrounding the important work being done by organizations, both private and public, to better understand the impacts of what are known as Social Determinants of Health – “the conditions in the environments where people are born, live, learn, work, play, worship, and age that affect a wide range of health, functioning, and quality-of-life outcomes and risks” (definition lifted from the [US Dept. of Health and Human Services](https://health.gov/healthypeople/priority-areas/social-determinants-health).

Social Determinants of Health (SDoH) can provide strong causal evidence for why certain subpopulations of our society are marginalized or disadvantaged by systemic factors. Consequently, population health professionals and actuaries alike have an interest in better understanding the relationships between SDoH and access to quality healthcare that is both affordable and can be sustainably provided by the care delivery system.

It is therefore reasonable to suspect that disparities in retirement-related outcomes between LGBTQ+ and non-LGBTQ+ populations are also highly dependent upon many of the same Social Determinants of Health (SDoH) factors that heavily influence healthcare outcomes, experiences, and costs.

In order to investigate this idea, I set out to explore the publicly-available [Medical Expenditure Panel Survey](https://meps.ahrq.gov/mepsweb/) (MEPS) datasets to determine if there were useful data available for distilling connections between retirement-related outcomes, many of which depend extensively on healthcare outcomes, and the lived socioeconomic experiences often encountered by LGBTQ+ individuals.

# About MEPS
The Medical Expenditure Panel Survey has been administered since 1996, and according the [Agency for Healthcare Research and Quality](https://www.ahrq.gov/) (AHRQ), which is the government agency at MEPS’ helm, MEPS is a collection of “data on the specific health services that Americans use, how frequently they use them, the cost of these services, and how they are paid for, as well as data on the cost, scope, and breadth of health insurance held by and available to U.S. workers” ([Survey Background, MEPS Homepage](https://meps.ahrq.gov/mepsweb/about_meps/survey_back.jsp)).

On the [MEPS Github page](https://github.com/HHS-AHRQ/MEPS), you’ll find several excellent code examples written in both SAS and R which I used to familiarize myself with the layout of the data. Furthermore, the MEPS staff regularly conducts well-crafted online training seminars.

As MEPS is a survey and therefore the data is either self-reported or imputed, there are some situations in which you’ll find the data isn’t perfect. And furthermore, MEPS provides [some basic ground rules](https://meps.ahrq.gov/survey_comp/precision_guidelines.shtml) about making inferences with the data, which include restrictions and guidance concerning how much you are permitted to slice and dice the data before your unweighted sample of respondents is too small. I discuss this guidance further in a subsequent section.

# My Approach: MEPS and LGBTQ+ Individuals
The MEPS questionnaire is broad and comprehensive, and includes questions ranging from basic demography facts to employment status, food stamp usage, diagnoses of key chronic conditions, who pays for the respondent’s insurance, what medications they filled, medical procedures they received, even down to the ethnicity of their providers.

However, one question that is glaringly absent from the panel survey questionnaire is any mention of the respondent’s LGBTQ+ identity. There are very good reasons to suspect adding these questions would impose unnecessary sample biases. 

At any rate, because MEPS does provide a way to identify respondents in the survey who are spouses of one another, and because MEPS provides the self-reported sex of each respondent, one can use this approach to create a dataset of all married respondents, and then easily label which are in same-sex marriages and which are not in same-sex marriages.

The R code that performs this analysis and prepares the data visualizations that follow is available on my personal Github site (the repository and content which you are currently reading).

# Caveats and Housekeeping
In the following infographics, I have used the 2019 datasets available on the MEPS website. Note that these are actual populations estimates based on the weighted survey design, so the population counts and dollar amounts below are intended to be representative of the US population, in context.

Next, please take care to note that MEPS recommends [not displaying estimates of any kind with a RSE (relative standard error) of .5 or higher](https://meps.ahrq.gov/survey_comp/precision_guidelines.shtml) due to the high degree of sampling error. Therefore, in the following images, take care to note that error bars extending more than 50% into the shaded bar should not be taken at face value. Conversely, error bars extending no more than 30% into the shaded bar can be regarded as sufficiently precise.

Finally, I want to reiterate that while the distinction between sex and gender is not lost on me (in particular in the context of analyzing causal connections between SDoH and healthcare outcomes), I must point out that the variable called “SEX” in the data is indeed, according to the MEPS handbook, intended to express the respondent’s gender. The handbook also points out that sometimes this value is assigned based on the name of the respondent or based on the relationship to other respondents in the same family or dwelling unit, which is obviously not ideal.

For consistency’s sake, I continue to refer to the variable in the context of sex and not gender in the visualizations below. This also means it is possible that some of these “same-sex” and “non-same-sex” couples could potentially include transgender individuals, but I will proceed with the materiality assumption that this does not occur in the data very frequently.

# Exploring the Demographic Composition of Same-Sex Marriages in the US
In the following infographics, I attempt to better understand the demographic composition of individuals in same-sex marriages by exploring the relationships between age, sex, income level, race, and insurance coverage status between the same-sex and non-same-sex marriage cohorts.

```{r Preprocessing, include=FALSE}

# Set options to deal with lonely PSUs. A PSU is a Primary Sampling Unit. Primary Sampling Units are divided among several sampling strata. The MEPS survey design package provides appropriate sampling weights for each strata in order for each sampling unit to be reweighted in proportion to the POI (Population of Interest - in this case ,the entire US).

# In some cases, our analysis might necessitate drilling down to very small subpopulations, which will whittle down the membership of some strata to 1 or fewer members. In this case, we might encounter some strata with a single member - a "lonely PSU" - at which point the Survey package will error out when computing the sample variance to determine the standard error for a particular statistic (mean, total sum, etc.) in our analyses. Setting this option will adjust the data in the single-PSU stratum so that it is centered at the entire sample mean instead of the particular stratum mean, which tends to be a more conservative computation of the variance and has the effect of contributing to a wider standard error estimate for any statistic of interest in the analysis.

# In short, the following line will conservatively recenter certain data points so that a standard error for statistics of interest (mean, total sum, etc.) are computable for all strata - even those containing a single PSU, with the tradeoff of a larger (and more conservative) magnitude of standard error.

# An excellent article that goes into more detail about this process (and expresses some concern about the magnitude of overconservatism that R's survey package employs in recentering the lonely PSU mean) can be read here:
# https://www.practicalsignificance.com/posts/bugs-with-singleton-strata/

options(survey.lonely.psu='adjust')

# The following lines of code make use of the custom MEPS R package developed by the MEPS staff. This package is not on CRAN and must be downloaded via Github using the "devtools" package, which is done in the "Initial_Setup" chunk of code, above.

# Download the 2019 Full Year Consolidated Data File
# https://meps.ahrq.gov/mepsweb/data_stats/download_data_files_detail.jsp?cboPufNumber=HC-216
fyc19 = MEPS::read_MEPS(year = 2019, type = "FYC")

# Download the 2018 Full Year Consolidated Data File
# https://meps.ahrq.gov/mepsweb/data_stats/download_data_files_detail.jsp?cboPufNumber=HC-209
fyc18 = MEPS::read_MEPS(year = 2018, type = "FYC")

# Download the 2017 Full Year Consolidated Data File
# https://meps.ahrq.gov/mepsweb/data_stats/download_data_files_detail.jsp?cboPufNumber=HC-201
fyc17 = MEPS::read_MEPS(year = 2017, type = "FYC")

# From the MEPS website at https://meps.ahrq.gov/mepsweb/data_stats/download_data_files.jsp:

# "The pooled linkage file contains the standardized variance strata and PSU variables for a pooled analysis of multiple years of MEPS data. The pooled replicates file contains 128 half sample indicators needed to calculate standard errors using balanced repeated replication (BRR) method either for a single year analysis or a pooled analysis of multiple years of MEPS data."
linkage = MEPS::read_MEPS(type = "Pooled linkage")

# Next, we will define some custom functions. These functions will be explained in subsequent documentation below at the time they are invoked.

count_family_size <- function(df) {
  # First get list of PIDs
  pid_list <- df %>% 
    distinct(PID) %>% 
    nrow()
}

check_family_size <- function(df) {
  # Retain only DUIDFAMY reference person
  rfpyr <- df %>% 
    filter(FAMRFPYR == 1) %>% 
    select(FAMSZEYR)
  
  rfpyr$FAMSZEYR
}

identify_same_sex_spouses <- function(df) {
  pid_list <- df %>% 
    distinct(PID, SEX, SPOUIDYY)
  
  pid_join <- pid_list %>% 
    inner_join(pid_list, by=c("PID"="SPOUIDYY")) %>% 
    mutate(sex_of_spouse = SEX.y,
           same_sex_lgl = SEX.x == SEX.y) %>% 
    select(PID, sex_of_spouse, same_sex_lgl)
  
  pid_join
}

count_married_individuals <- function(df) {
  pid_list <- df %>% 
    filter(MARRYYYX == 1) %>% 
    distinct(PID) %>% 
    nrow()
}

count_married_individuals_in_ssc <- function(df) {
  count <- df %>% 
    filter(same_sex_lgl == T) %>% 
    nrow()
}

# First, we must do some preprocessing with the MEPS FYC files we have downloaded. The following block of code performs the following steps for the 2019 FYC file.

# 3. Per section 3.5.2 of the MEPS FYC 2019 documentation manual linked above, a family consists of two or more persons living together in the same household who are related by blood, marriage, or adoption. As we want to use same-sex marriage as a means to identify same-sex individuals, we're going to first make sure we isolate our cohort of individuals to those who are part of a family, as defined by MEPS. This requires that we perform the following steps:
#     a. Restrict records to FAMWT19F (now renamed to FAMWTYYF) to positive nonzero weights only.
#     b. Concatenate DUID (Dwelling Unit ID) and FAMIDYR (eligible members of eligible annualized families within a single Dwelling Unit ID) into a single variable known as DUIDFAMY.

fyc19x  <- fyc19 %>% 
  # 1. Subsets only relevant columns out of the over roughly 1500 columns available.
  select(DUID, PID, DUPERSID, PANEL, SEX, AGELAST, INSCOV19, REGION19, RACETHX, POVCAT19, RXEXP19, TOTEXP19, TOTSLF19, VARSTR, VARPSU, PERWT19F, MARRY19X, SPOUID19, FAMIDYR, FAMWT19F, FAMRFPYR, FAMSZEYR, PROBPY42, HIBPDX, CHOLDX, DIABDX_M18) %>% 
  # 2. As we will be pooling the FYC 2019 and 2018 files, we wish to rename fields with a '19' to a more general (e.g., 'YY') label. We will do the same with 2018 fields with names that include '18'. Note that the field DIABDX_M18 contains responses to a survey question which is only administered to respondents aged 18 or over, so this field is renamed entirely for the sake of convenience and the '18' has nothing to do with the year 2018.
  rename(PERWTYYF=PERWT19F,
         MARRYYYX=MARRY19X,
         SPOUIDYY=SPOUID19,
         FAMWTYYF=FAMWT19F,
         AGEYYX=AGELAST,
         REGIONYY=REGION19,
         INSCOVYY=INSCOV19,
         TOTEXPYY=TOTEXP19,
         RXEXPYY=RXEXP19,
         TOTSLFYY=TOTSLF19,
         POVCATYY=POVCAT19,
         PROBPYYY=PROBPY42,
         DIABDX=DIABDX_M18) %>% 
  # 3. Per section 3.5.2 of the MEPS FYC 2019 documentation manual linked above, a family consists of two or more persons living together in the same household who are related by blood, marriage, or adoption. As we want to use same-sex marriage as a means to identify same-sex individuals, we're going to first make sure we isolate our cohort of individuals to those who are part of a family, as defined by MEPS. This requires that we perform the following steps:
  #     a. Restrict records to FAMWT19F (now renamed to FAMWTYYF) to positive nonzero weights only.
  filter(FAMWTYYF > 0) %>%
  #     b. Concatenate DUID (Dwelling Unit ID) and FAMIDYR (eligible members of eligible annualized families within a single Dwelling Unit ID) into a single variable known as DUIDFAMY.
  mutate(DUIDFAMY = stringr::str_c(DUID, FAMIDYR)) %>% 
  # 4. Next we will group by this new variable and use the "nest" function to create a dataset of datasets, so that the resulting dataset will contain a single unique DUIDFAMY value in one column and the second column will consist of a table of all the individual PSUs which are members of that combination of Dwelling Unit ID and Family ID
  group_by(DUIDFAMY) %>%  
  tidyr::nest() %>% 
  # 5. Finally, we will compute some summary statistics on each DUIDFAMY row into new columns, including:
  #   5a. 'family_size_check': A quality check that computes the number of PSUs within each DUIDFAMY and subtracts that value from the value FAMSZEYR for the unique DUIDFAMY reference person (FAMRFPYR=1). This number should be zero in the vast majority of cases.
  #   5b. 'married_individuals': A count of married individuals within that DUIDFAMY - in the vast majority of cases, this should be 0 or 2. Other values can exist, such as 1 for a married individual within a family that does not occupy the same Dwelling Unit as their spouse, or 3 for such a person who resides in a Dwelling Unit / Family as another married couple, etc. We will look at a quality check of this.
  #   5c. 'spouse_matrix': another column containing a dataset consisting of each PID within that DUIDFAMY, their sex, their spouse's sex, and a logical variable indicating whether or not those sexes are identical.
  #   5d. 'married_individuals_in_ssc': a conditional sum variable that sums up all individuals who are both married (using the column described in b, above) and in same-sex marriages (using the column described in c, above) %>% 
  mutate(family_size_count = purrr::map_int(data, count_family_size)) %>% 
  mutate(family_size_check = purrr::map_int(data, check_family_size) - family_size_count) %>% 
  mutate(married_individuals = purrr::map_int(data, count_married_individuals)) %>% 
  mutate(spouse_matrix = purrr::map(data, identify_same_sex_spouses)) %>% 
  mutate(married_individuals_in_ssc = purrr::map_int(spouse_matrix, count_married_individuals_in_ssc))

# Per the 2019 FYC documentation file Table 3.3, we should expect the above code to construct a data table that has 11,924 records.

# We want to explore some one-way frequency tables to make sure these data quality checks are coming in as expected.
# Reported family size minus Count of unique PIDs within each DUIDFAMY - we expect the vast majority of responses to be zero.
table(fyc19x$family_size_check)
# Count of married individuals within each DUIDFAMY - expecting the vast majority of responses to be 0 or 2
table(fyc19x$married_individuals)
# Count of married individuals in Same-Sex marriages within each DUIDFAMY - again expecting the vast majority of responses to be 0 or 2
table(fyc19x$married_individuals_in_ssc)

# Now we will perform exactly the same steps in the same order to the 2018 and 2017 FYC files retrieved using the MEPS package.

fyc18x  <- fyc18 %>% 
  select(DUID, PID, DUPERSID, PANEL, SEX, AGELAST, INSCOV18, REGION18, RACETHX, POVCAT18, RXEXP18, TOTEXP18, TOTSLF18, VARSTR, VARPSU, PERWT18F, MARRY18X, SPOUID18, FAMIDYR, FAMWT18F, FAMRFPYR, FAMSZEYR, PROBPY42, HIBPDX, CHOLDX, DIABDX_M18) %>% 
  rename(PERWTYYF=PERWT18F,
         MARRYYYX=MARRY18X,
         SPOUIDYY=SPOUID18,
         FAMWTYYF=FAMWT18F,
         AGEYYX=AGELAST,
         REGIONYY=REGION18,
         INSCOVYY=INSCOV18,
         TOTEXPYY=TOTEXP18,
         RXEXPYY=RXEXP18,
         TOTSLFYY=TOTSLF18,
         POVCATYY=POVCAT18,
         PROBPYYY=PROBPY42,
         DIABDX=DIABDX_M18) %>% 
  filter(FAMWTYYF > 0) %>%      
  mutate(DUIDFAMY = stringr::str_c(DUID, FAMIDYR)) %>%
  group_by(DUIDFAMY) %>%  
  tidyr::nest() %>% 
  mutate(family_size_count = purrr::map_int(data, count_family_size)) %>% 
  mutate(family_size_check = purrr::map_int(data, check_family_size) - family_size_count) %>% 
  mutate(married_individuals = purrr::map_int(data, count_married_individuals)) %>% 
  mutate(spouse_matrix = purrr::map(data, identify_same_sex_spouses)) %>% 
  mutate(married_individuals_in_ssc = purrr::map_int(spouse_matrix, count_married_individuals_in_ssc))

# Per the 2018 FYC documentation file Table 3.3, we should expect the above code to construct a data table that has 12,475 records.

# We want to explore some one-way frequency tables to make sure these data quality checks are coming in as expected.
# Reported family size minus Count of unique PIDs within each DUIDFAMY - we expect the vast majority of responses to be zero.
table(fyc18x$family_size_check)
# Count of married individuals within each DUIDFAMY - expecting the vast majority of responses to be 0 or 2
table(fyc18x$married_individuals)
# Count of married individuals in Same-Sex marriages within each DUIDFAMY - again expecting the vast majority of responses to be 0 or 2
table(fyc18x$married_individuals_in_ssc)

# In this final step, we wish to take the horizontal join (union) of the 2018 and 2019 data files so that we can pool 2018 and 2019 data in this analysis. Since we are ultimately performing an analysis on cohorts of married individuals within the same DU and FAMID, we will also want to "flatten" our family-level datasets back into individual DUPERSIDs and then apply the Pooled Linkage file appropriately as described in the MEPS documentation.

fyc17x  <- fyc17 %>% 
  select(DUID, PID, DUPERSID, PANEL, SEX, AGELAST, INSCOV17, REGION17, RACETHX, POVCAT17, RXEXP17, TOTEXP17, TOTSLF17, VARSTR, VARPSU, PERWT17F, MARRY17X, SPOUID17, FAMIDYR, FAMWT17F, FAMRFPYR, FAMSZEYR, PROBPY42, HIBPDX, CHOLDX, DIABDX) %>% 
  rename(PERWTYYF=PERWT17F,
         MARRYYYX=MARRY17X,
         SPOUIDYY=SPOUID17,
         FAMWTYYF=FAMWT17F,
         AGEYYX=AGELAST,
         REGIONYY=REGION17,
         INSCOVYY=INSCOV17,
         TOTEXPYY=TOTEXP17,
         RXEXPYY=RXEXP17,
         TOTSLFYY=TOTSLF17,
         POVCATYY=POVCAT17,
         PROBPYYY=PROBPY42) %>% 
  filter(FAMWTYYF > 0) %>%      
  mutate(DUIDFAMY = stringr::str_c(DUID, FAMIDYR)) %>%
  group_by(DUIDFAMY) %>%  
  tidyr::nest() %>% 
  mutate(family_size_count = purrr::map_int(data, count_family_size)) %>% 
  mutate(family_size_check = purrr::map_int(data, check_family_size) - family_size_count) %>% 
  mutate(married_individuals = purrr::map_int(data, count_married_individuals)) %>% 
  mutate(spouse_matrix = purrr::map(data, identify_same_sex_spouses)) %>% 
  mutate(married_individuals_in_ssc = purrr::map_int(spouse_matrix, count_married_individuals_in_ssc))

# Per the 2017 FYC documentation file Table 3.3, we should expect the above code to construct a data table that has 12,756 records.

# We want to explore some one-way frequency tables to make sure these data quality checks are coming in as expected.
# Reported family size minus Count of unique PIDs within each DUIDFAMY - we expect the vast majority of responses to be zero.
table(fyc17x$family_size_check)
# Count of married individuals within each DUIDFAMY - expecting the vast majority of responses to be 0 or 2
table(fyc17x$married_individuals)
# Count of married individuals in Same-Sex marriages within each DUIDFAMY - again expecting the vast majority of responses to be 0 or 2
table(fyc17x$married_individuals_in_ssc)

# In this final step, we wish to take the horizontal join (union) of the 2017, 2018 and 2019 data files so that we can pool 2017, 2018 and 2019 data in this analysis. Since we are ultimately performing an analysis on cohorts of married individuals within the same DU and FAMID, we will also want to "flatten" our family-level datasets back into individual DUPERSIDs and then apply the Pooled Linkage file appropriately as described in the MEPS documentation.

fyc17_18_19x_flat <- fyc19x %>% 
  # First horizontally merge (using UNION ALL) the three datasets
  union_all(fyc18x) %>% 
  union_all(fyc17x) %>% 
  # Next, we want to retain all the originally nested data at the individual person level alongside any custom same-sex marriage indicators that we computed in the previous step in one combined nested dataset for each DUFAMYID row in our combined 2017 - 2019 family-level dataset.
  mutate(final_data = purrr::map2(data, spouse_matrix, ~ .x %>% left_join(.y, by=c("PID"="PID")))) %>% 
  # Next we will delete two dataset columns since they are redundant after the last line, to save on memory.
  select(-data, -spouse_matrix) %>% 
  # Finally we will group by all fields which are non-nested dataset columns and call the unnest function, which will unnest the dataset columns and flatten our table.
  group_by(DUIDFAMY, family_size_count, family_size_check, married_individuals, married_individuals_in_ssc) %>% 
  tidyr::unnest(final_data) %>% 
  # Ungroup merely ungroups the group_by statement called earlier.
  ungroup() %>% 
  # In some cases, sex_of_spouse is NA because none of the individuals within the Dwelling Unit or Family Unit are married to one another. We wish to remove these individuals from the analysis. Additionally, we want to only include only married individuals, since same-sex marriage is our "clue" which suggests potential LGBTQ+ status. Since marriage status is very likely a confounding variable for many of the subsequent visualizations we will prepare, we wish to restrict our analysis to only individuals which are married.
  filter(MARRYYYX == 1 & !is.na(sex_of_spouse)) %>% 
  # In some cases, respondents do not include age and it cannot be imputed using other data sources. These respondents are coded with a -1 for age. We do not wish to include these responses in our analysis.
  filter(AGEYYX > 0) %>% 
  # This is a variable to simply provide a sample weighting for when we aggregate
  mutate(Individuals = 1) %>% 
  # Finally we will define some categorical variables for labeling visualizations
  mutate(AGE_GRP_2 = if_else(AGEYYX >= 65, "65 and over", "18 - 64")) %>% 
  mutate(AGE_GRP_5 = case_when(AGEYYX < 5 ~ "Under 5",
                               AGEYYX >= 5 & AGEYYX <= 17 ~ "5 - 17",
                               AGEYYX >= 18 & AGEYYX <= 44 ~ "18 - 44",
                               AGEYYX >= 45 & AGEYYX <= 64 ~ "45 - 64",
                               AGEYYX >= 65 ~ "65 and over",
                               T ~ as.character(AGEYYX))) %>%
    mutate(AGE_GRP_8 = case_when(AGEYYX < 5 ~ "Under 5",
                               AGEYYX >= 5 & AGEYYX <= 17 ~ "5 - 17",
                               AGEYYX >= 18 & AGEYYX <= 29 ~ "18 - 29",
                               AGEYYX >= 30 & AGEYYX <= 39 ~ "30 - 39",
                               AGEYYX >= 40 & AGEYYX <= 49 ~ "40 - 49",
                               AGEYYX >= 50 & AGEYYX <= 59 ~ "50 - 59",
                               AGEYYX >= 60 & AGEYYX <= 69 ~ "60 - 69",
                               AGEYYX >= 70 ~ "70 and over",
                               T ~ as.character(AGEYYX))) %>%
  mutate(INSCOV_DSC = case_when(INSCOVYY == 1 ~ "Any Private",
                                INSCOVYY == 2 ~ "Public Only",
                                INSCOVYY == 3 ~ "Uninsured",
                                T ~ as.character(INSCOVYY))) %>% 
  mutate(UNINS_FLG = case_when(INSCOVYY == 3 ~ "Uninsured",
                               INSCOVYY != 3 ~ "Insured",
                               T ~ as.character(INSCOVYY))) %>% 
  mutate(REG_DSC = case_when(REGIONYY == -1 ~ "Inapplicable",
                             REGIONYY == 1 ~ "Northeast",
                             REGIONYY == 2 ~ "Midwest",
                             REGIONYY == 3 ~ "South",
                             REGIONYY == 4 ~ "West",
                             T ~ as.character(REGIONYY))) %>% 
  mutate(RACE_DSC = case_when(RACETHX == 1 ~ "Hispanic",
                              RACETHX == 2 ~ "Non-Hispanic White Only",
                              RACETHX == 3 ~ "Non-Hispanic Black Only",
                              RACETHX == 4 ~ "Non-Hispanic Asian Only",
                              RACETHX == 5 ~ "Non-Hispanic Other Race or Multiple Race",
                              T ~ as.character(RACETHX))) %>% 
  mutate(POVCAT_DSC = case_when(POVCATYY == 1 ~ "less than 100%",
                                POVCATYY == 2 ~ "100% to less than 125%",
                                POVCATYY == 3 ~ "125% to less than 200%",
                                POVCATYY == 4 ~ "200% to less than 400%",
                                POVCATYY == 5 ~ "400% or more",
                                T ~ as.character(POVCATYY))) %>% 
  mutate(HAS_EXP = if_else(TOTEXPYY > 0, "Had Healthcare Expenses", "Did Not Have Healthcare Expenses")) %>% 
  mutate(DIABDX_DSC = case_when(DIABDX == 1 ~ "Diagnosed with Diabetes", 
                                DIABDX == 2 ~ "Not Diagnosed with Diabetes", 
                                T ~ "Unknown")) %>% 
  mutate(HIBPDX_DSC = case_when(HIBPDX == 1 ~ "Diagnosed with High Blood Pressure", 
                                HIBPDX == 2 ~ "Not Diagnosed with High Blood Pressure", 
                                T ~ "Unknown")) %>% 
  mutate(CHOLDX_DSC = case_when(CHOLDX == 1 ~ "Diagnosed with High Cholesterol", 
                                CHOLDX == 2 ~ "Not Diagnosed with High Cholesterol", 
                                T ~ "Unknown")) %>% 
  mutate(SEX_DSC = if_else(SEX == 1, "Male", if_else(SEX == 2, "Female", "Unknown"))) %>% 
  mutate(SSC_DSC = if_else(same_sex_lgl == T, "Married Individuals in Same-Sex Marriages", "Married Individuals Not in Same-Sex Marriages")) %>% 
  mutate(FAMSZEYR_GRP = case_when(FAMSZEYR <= 2 ~ "1 - 2 persons",
                                  FAMSZEYR >= 3 & FAMSZEYR <= 4 ~ "3 - 4 persons",
                                  FAMSZEYR >= 5 & FAMSZEYR <= 6 ~ "5 - 6 persons",
                                  FAMSZEYR >= 7 ~ "7+ persons")) 

# Two additional pooling considerations to pool 2017 - 2019 data follow: 

# Divide survey weights by two and store in a new "pooled weight" column so that we can still use only 2017, 2018 or 2019 data only, if needed. Directions to adjust the analytic weight variable (PERWTYYF) by division by 3 (the number of pooled years) are in section 4.0 of the Pooled Linkage file documentation, here:
# https://meps.ahrq.gov/data_stats/download_data/pufs/h036/h36u20doc.shtml#2

fyc17_18_19x_flat <- fyc17_18_19x_flat %>% 
  mutate(POOLWTYY = PERWTYYF / 3)

# Join to Pooled Linkages file - this file ensures we are not "double counting" in our standard error calculations from panel participants sampled across multiple years. More info on the linkage process can be found at the following URL, in section "3.0 Linking Instructions":
# https://meps.ahrq.gov/data_stats/download_data/pufs/h036/h36u20doc.shtml#CTechnical

linkage_sub <- linkage %>% 
  select(DUPERSID, PANEL, STRA9620, PSU9620)

fyc17_18_19x_flat <- fyc17_18_19x_flat %>% 
  left_join(linkage_sub, by = c("DUPERSID", "PANEL"))

# Define the survey design - here we are using the pooled weights which were divided by two, and pooled ID/STRATA variables that were joined into our dataset, from the previous steps.
mepsdsgn = svydesign(
  id = ~PSU9620,
  strata = ~STRA9620,
  weights = ~POOLWTYY,
  data = fyc17_18_19x_flat,
  nest = TRUE)

```

```{r Marriage_Class_And_Sex, echo=FALSE}

# Import the Milliman color palette for visualizations:
custom_palette <- c("#0078D4", "#00A562", "#FFA100", "#50BDFF", "#74BF60", "#FFC800")

# Set table output format to HTML for easier rendering for data table presentations:
options(knitr.table.format = "html") 

# Visualizations appear in several steps. 

# First, the title:
fyc17_18_19x_age_sex.title <- "Estimated Number of Married Individuals"
fyc17_18_19x_age_sex.subtitle <- "By Marriage Classification and Sex"

# Next, we compute the data table for the underlying visualizations using the Survey package and remove the rownames as they are clunky and make the underlying data table less pretty when that is produced.

# By using the Svyby function in the Survey package, supplying the ENTIRE population of interest file (all married individuals) and applying a formula of subsetting variables, we are conforming to the caveat provided in the Pooled Linkage documentation in section "5.0 Subpopulation Analysis Caveat" at the following URL:
# https://meps.ahrq.gov/data_stats/download_data/pufs/h036/h36u20doc.shtml#2
fyc17_18_19x_age_sex.data <- svyby(~Individuals, by = ~AGE_GRP_2 + SEX_DSC + SSC_DSC, FUN = svytotal, design = mepsdsgn)

rownames(fyc17_18_19x_age_sex.data) <- NULL

# Next we create the visualization based on the data table
fyc17_18_19x_age_sex.plot <- fyc17_18_19x_age_sex.data %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = SEX_DSC,
                       y = Individuals)) +
  scale_fill_manual(values = custom_palette) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=Individuals-1.96*se, ymax=Individuals+1.96*se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ SSC_DSC, ncol = 2, scales="free_y", labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title=fyc17_18_19x_age_sex.title,
       subtitle=fyc17_18_19x_age_sex.subtitle,
       x = "Age Grouping",
       y = "Estimate of Individuals (Survey Weighted)",
       fill = "Gender",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

# Next, we render the visualization
fyc17_18_19x_age_sex.plot

# Then, we create the publication table object for displaying the underlying data:
fyc17_18_19x_age_sex.table <- fyc17_18_19x_age_sex.data %>% 
  arrange(SSC_DSC, AGE_GRP_2, SEX_DSC) %>% 
  rename(`Standard Error`=se,
         Estimate=Individuals,
         `Marriage Classification`=SSC_DSC,
         `Age Group`=AGE_GRP_2,
         `Gender`=SEX_DSC) %>% 
  mutate(rse = `Standard Error`/Estimate,
         rse_flag = case_when(rse > .5 ~ "†", 
                              rse >= .3 & rse <= .5 ~ "*", 
                              T ~ ""),
         `95% CI Lower Bound` = Estimate-1.96*`Standard Error`,
         `95% CI Upper Bound` = Estimate+1.96*`Standard Error`,
         `Relative Standard Error`= paste(scales::percent(`Standard Error`/Estimate), rse_flag)) %>% 
  select(-rse, -rse_flag) %>%  
  kbl(format.args = list(big.mark = ",", digits=3),
      caption = paste0("Data Table for '", fyc17_18_19x_age_sex.title, " ", fyc17_18_19x_age_sex.subtitle, "'")) %>% 
    kable_classic_2(full_width = F, html_font = "Arial") %>% 
    footnote(general = "From MEPS' Precision Standards Guidelines:",
             symbol = c("Estimate can be reported but flagged with an * to indicate that its precision is questionable.", "Estimate should not be reported or displayed in tables due to extremely large sampling error."))

fyc17_18_19x_age_sex.table
```

```{r Marriage_Class_And_Plan_Coverage, echo=FALSE}

# First, the title:
fyc17_18_19x_age_cov.title <- "Estimated Number of Married Individuals"
fyc17_18_19x_age_cov.subtitle <- "By Marriage Classification and Health Plan Coverage"

# Next, the data:
fyc17_18_19x_age_cov.data <- svyby(~Individuals, by = ~AGE_GRP_2 + INSCOV_DSC + SSC_DSC, FUN = svytotal, design = mepsdsgn) 

rownames(fyc17_18_19x_age_cov.data) <- NULL

# Next, the plot:
fyc17_18_19x_age_cov.plot <- fyc17_18_19x_age_cov.data %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = INSCOV_DSC,
                       y = Individuals)) +
  scale_fill_manual(values = custom_palette) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=Individuals-1.96*se, ymax=Individuals+1.96*se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ SSC_DSC, ncol = 2, scales="free_y", labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title=fyc17_18_19x_age_cov.title,
       subtitle=fyc17_18_19x_age_cov.subtitle,
       x = "Age Grouping",
       y = "Estimate of Individuals (Survey Weighted)",
       fill = "Health Plan Coverage",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

fyc17_18_19x_age_cov.plot

# Finally, the table:
fyc17_18_19x_age_cov.table <- fyc17_18_19x_age_cov.data %>% 
  arrange(SSC_DSC, AGE_GRP_2, INSCOV_DSC) %>% 
  rename(`Standard Error`=se,
         Estimate=Individuals,
         `Marriage Classification`=SSC_DSC,
         `Age Group`=AGE_GRP_2,
         `Health Plan Coverage`=INSCOV_DSC) %>% 
  mutate(rse = `Standard Error`/Estimate,
         rse_flag = case_when(rse > .5 ~ "†", 
                              rse >= .3 & rse <= .5 ~ "*", 
                              T ~ ""),
         `95% CI Lower Bound` = Estimate-1.96*`Standard Error`,
         `95% CI Upper Bound` = Estimate+1.96*`Standard Error`,
         `Relative Standard Error`= paste(scales::percent(`Standard Error`/Estimate), rse_flag)) %>% 
  select(-rse, -rse_flag) %>%  
  kbl(format.args = list(big.mark = ",", digits=3),
      caption = paste0("Data Table for '", fyc17_18_19x_age_cov.title, " ", fyc17_18_19x_age_cov.subtitle, "'")) %>% 
    kable_classic_2(full_width = F, html_font = "Arial") %>% 
    footnote(general = "From MEPS' Precision Standards Guidelines:",
             symbol = c("Estimate can be reported but flagged with an * to indicate that its precision is questionable.", "Estimate should not be reported or displayed in tables due to extremely large sampling error."))

fyc17_18_19x_age_cov.table

```

```{r Marriage_Class_And_Race_Ethnicity, echo=FALSE}

# First, the title:
fyc17_18_19x_age_race.title <- "Estimated Number of Married Individuals"
fyc17_18_19x_age_race.subtitle <- "By Marriage Classification and Race, Ethnicity"

# Next, the data:
fyc17_18_19x_age_race.data <- svyby(~Individuals, by = ~AGE_GRP_2 + RACE_DSC + SSC_DSC, FUN = svytotal, design = mepsdsgn) 

rownames(fyc17_18_19x_age_race.data) <- NULL

# Next, the plot:
fyc17_18_19x_age_race.plot <- fyc17_18_19x_age_race.data %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = RACE_DSC,
                       y = Individuals)) +
  scale_fill_manual(values = custom_palette) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=Individuals-1.96*se, ymax=Individuals+1.96*se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ SSC_DSC, ncol = 2, scales="free_y", labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title=fyc17_18_19x_age_race.title,
       subtitle=fyc17_18_19x_age_race.subtitle,
       x = "Age Grouping",
       y = "Estimate of Individuals (Survey Weighted)",
       fill = "Race and Ethnicity",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

fyc17_18_19x_age_race.plot

# Finally, the table:
fyc17_18_19x_age_race.table <- fyc17_18_19x_age_race.data %>% 
  arrange(SSC_DSC, AGE_GRP_2, RACE_DSC) %>% 
  rename(`Standard Error`=se,
         Estimate=Individuals,
         `Marriage Classification`=SSC_DSC,
         `Age Group`=AGE_GRP_2,
         `Race & Ethnicity`=RACE_DSC) %>% 
  mutate(rse = `Standard Error`/Estimate,
         rse_flag = case_when(rse > .5 ~ "†", 
                              rse >= .3 & rse <= .5 ~ "*", 
                              T ~ ""),
         `95% CI Lower Bound` = Estimate-1.96*`Standard Error`,
         `95% CI Upper Bound` = Estimate+1.96*`Standard Error`,
         `Relative Standard Error`= paste(scales::percent(`Standard Error`/Estimate), rse_flag)) %>% 
  select(-rse, -rse_flag) %>%  
  kbl(format.args = list(big.mark = ",", digits=3),
      caption = paste0("Data Table for '", fyc17_18_19x_age_race.title, " ", fyc17_18_19x_age_race.subtitle, "'")) %>% 
    kable_classic_2(full_width = F, html_font = "Arial") %>% 
    footnote(general = "From MEPS' Precision Standards Guidelines:",
             symbol = c("Estimate can be reported but flagged with an * to indicate that its precision is questionable.", "Estimate should not be reported or displayed in tables due to extremely large sampling error."))

# Render table
fyc17_18_19x_age_race.table

```

```{r Marriage_Class_And_Income, echo=FALSE}

# First, the title:
fyc18_19x_age_povcat.title <- "Estimated Number of Married Individuals"
fyc18_19x_age_povcat.subtitle <- "By Marriage Classification and Income"

# Next, the data:
fyc18_19x_age_povcat.data <- svyby(~Individuals, by = ~AGE_GRP_2 + POVCAT_DSC + SSC_DSC, FUN = svytotal, design = mepsdsgn) 

rownames(fyc18_19x_age_povcat.data) <- NULL

# Reorder the factors in the plot
fyc18_19x_age_povcat.data <- fyc18_19x_age_povcat.data %>% 
  mutate(POVCAT_DSC = fct_relevel(POVCAT_DSC, 
                                  "less than 100%",
                                  "100% to less than 125%",
                                  "125% to less than 200%",
                                  "200% to less than 400%",
                                  "400% or more"))

# Next, the plot:
fyc18_19x_age_povcat.plot <- fyc18_19x_age_povcat.data %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = POVCAT_DSC,
                       y = Individuals)) +
  scale_fill_manual(values = custom_palette) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=Individuals-1.96*se, ymax=Individuals+1.96*se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ SSC_DSC, ncol = 2, scales="free_y", labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title=fyc18_19x_age_povcat.title,
       subtitle=fyc18_19x_age_povcat.subtitle,
       x = "Age Grouping",
       y = "Estimate of Individuals (Survey Weighted)",
       fill = "Income as % of FPL",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

fyc18_19x_age_povcat.plot

# Finally, the table:
fyc18_19x_age_povcat.table <- fyc18_19x_age_povcat.data %>% 
  arrange(SSC_DSC, AGE_GRP_2, POVCAT_DSC) %>% 
  rename(`Standard Error`=se,
         Estimate=Individuals,
         `Marriage Classification`=SSC_DSC,
         `Age Group`=AGE_GRP_2,
         `Income as % of FPL`=POVCAT_DSC) %>%   mutate(rse = `Standard Error`/Estimate,
         rse_flag = case_when(rse > .5 ~ "†", 
                              rse >= .3 & rse <= .5 ~ "*", 
                              T ~ ""),
         `95% CI Lower Bound` = Estimate-1.96*`Standard Error`,
         `95% CI Upper Bound` = Estimate+1.96*`Standard Error`,
         `Relative Standard Error`= paste(scales::percent(`Standard Error`/Estimate), rse_flag)) %>% 
  select(-rse, -rse_flag) %>%  
  kbl(format.args = list(big.mark = ",", digits=3),
      caption = paste0("Data Table for '", fyc18_19x_age_povcat.title, " ", fyc18_19x_age_povcat.subtitle, "'")) %>% 
    kable_classic_2(full_width = F, html_font = "Arial") %>% 
    footnote(general = "From MEPS' Precision Standards Guidelines:",
             symbol = c("Estimate can be reported but flagged with an * to indicate that its precision is questionable.", "Estimate should not be reported or displayed in tables due to extremely large sampling error."))

fyc18_19x_age_povcat.table

```

One finding I took away from these visualization exercises that was surprising to me is that marriage by race/ethnicity appears to be proportionally similar between same-sex and different-sex marriages, with the exception of Hispanic and non-Hispanic Asian groups, where there appears to be less adoption of same-sex marriages in the 18-65 age ranges in these race and ethnicity groupings. This could potentially indicate a greater deal of social acceptance of same-sex marriages among non-Hispanic white populations.

This is an important point of discussion as it illustrates the need for researchers and policymakers to better understand the idea of intersectionality within the many subpopulations within LGBTQ+ groups. As marriage tends to confer financial security and stabilization benefits, to both participants in the couple, then it follows that LGBTQ+ individuals who are white are more likely to access these benefits than their non-white LGBTQ+ counterparts, which can contribute to additional disparities along racial lines which are fully contained within the LGBTQ+ population.

# Visualizing Total Healthcare Expenditures
It is also the case that LGBTQ+ individuals can possess unique healthcare needs or face different barriers to access to healthcare, both of which can move the needle on the cost of healthcare – particularly in retirement, in which individuals are more likely to face one or more costly chronic conditions such as heart disease, diabetes, or asthma. 

To better determine if there are relationships between these demographic factors and the cost of care – particularly for older age groups, I prepared the following series of visualizations below that examine the average individual expenditures broken out on the same demographic features as the visualizations above.

```{r Exp_Marriage_Class_And_Sex, echo=FALSE}

# Titles:
fyc17_18_19x_age_sex_exp.title <- "Estimated Healthcare Expenditures"
fyc17_18_19x_age_sex_exp.subtitle <- "By Marriage Classification and Sex"

# Data preproceessing:
fyc17_18_19x_age_sex_exp.data <- svyby(~TOTEXPYY + RXEXPYY, by = ~AGE_GRP_2 + SEX_DSC + SSC_DSC, FUN = svymean, design = mepsdsgn) %>% 
  rename("est.TOTEXPYY"="TOTEXPYY",
         "est.RXEXPYY"="RXEXPYY") %>% 
  pivot_longer(ends_with(c("TOTEXPYY","RXEXPYY")),
               names_to = c("measure", "type"),
               names_pattern = "(est|se)\\.(.*)",
               values_to = "value") %>% 
  pivot_wider(names_from = "measure",
              values_from = "value") %>% 
  mutate(TYPE_DSC = if_else(type == "TOTEXPYY", "All Healthcare Expenditures", "RX Expenditures Only"))

# Build plot
fyc17_18_19x_age_sex_exp.plot <- fyc17_18_19x_age_sex_exp.data %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = SEX_DSC,
                       y = est)) +
  scale_fill_manual(values = custom_palette) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=est-1.96*se, ymax=est+1.96*se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::dollar) +
  facet_grid(TYPE_DSC ~ SSC_DSC, scales="free_y", labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title="Estimated Healthcare Expenditures",
       subtitle="By Marriage Classification and Sex",
       x = "Age Grouping",
       y = "Individual Healthcare Spend (Survey Weighted)",
       fill = "Gender",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

# Render plot
fyc17_18_19x_age_sex_exp.plot

# Build data table
fyc17_18_19x_age_sex_exp.table <- fyc17_18_19x_age_sex_exp.data %>% 
  select(-type) %>% 
  relocate(TYPE_DSC, .after=SSC_DSC) %>% 
  arrange(SSC_DSC, AGE_GRP_2, SEX_DSC, TYPE_DSC) %>% 
  rename(`Standard Error`=se,
         Estimate=est,
         `Expenditure Type`=TYPE_DSC,
         `Marriage Classification`=SSC_DSC,
         `Age Group`=AGE_GRP_2,
         `Gender`=SEX_DSC) %>% 
  mutate(rse = `Standard Error`/Estimate,
         rse_flag = case_when(rse > .5 ~ "†", 
                              rse >= .3 & rse <= .5 ~ "*", 
                              T ~ ""),
         `95% CI Lower Bound` = Estimate-1.96*`Standard Error`,
         `95% CI Upper Bound` = Estimate+1.96*`Standard Error`,         
         `Relative Standard Error`= paste(scales::percent(`Standard Error`/Estimate), rse_flag)) %>% 
  select(-rse, -rse_flag) %>%  
  kbl(format.args = list(big.mark = ",", digits=3),
      caption = paste0("Data Table for '", fyc18_19x_age_sex_exp.title, " ", fyc18_19x_age_sex_exp.subtitle, "'")) %>% 
    kable_classic_2(full_width = F, html_font = "Arial") %>% 
    footnote(general = "From MEPS' Precision Standards Guidelines:",
             symbol = c("Estimate can be reported but flagged with an * to indicate that its precision is questionable.", "Estimate should not be reported or displayed in tables due to extremely large sampling error."))

# Render data table
fyc17_18_19x_age_sex_exp.table

```

```{r Exp_Marriage_Class_And_Plan_Coverage, echo=FALSE}

# Titles:
fyc17_18_19x_age_cov_exp.title <- "Estimated Healthcare Expenditures"
fyc17_18_19x_age_cov_exp.subtitle <- "By Marriage Classification and Health Plan Coverage"

# Data preproceessing:
fyc17_18_19x_age_cov_exp.data <- svyby(~TOTEXPYY+RXEXPYY, by = ~AGE_GRP_2 + INSCOV_DSC + SSC_DSC, FUN = svymean, design = mepsdsgn) %>% 
  rename("est.TOTEXPYY"="TOTEXPYY",
         "est.RXEXPYY"="RXEXPYY") %>% 
  pivot_longer(ends_with(c("TOTEXPYY","RXEXPYY")),
               names_to = c("measure", "type"),
               names_pattern = "(est|se)\\.(.*)",
               values_to = "value") %>% 
  pivot_wider(names_from = "measure",
              values_from = "value") %>% 
  mutate(TYPE_DSC = if_else(type == "TOTEXPYY", "All Healthcare Expenditures", "RX Expenditures Only"))

# Build plot
fyc17_18_19x_age_cov_exp.plot <- fyc17_18_19x_age_cov_exp.data %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = INSCOV_DSC,
                       y = est)) +
  scale_fill_manual(values = custom_palette) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=est-1.96*se, ymax=est+1.96*se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::dollar) +
  facet_grid(TYPE_DSC ~ SSC_DSC, scales="free_y", labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title=fyc17_18_19x_age_cov_exp.title,
       subtitle=fyc17_18_19x_age_cov_exp.subtitle,
       x = "Age Grouping",
       y = "Individual Healthcare Spend (Survey Weighted)",
       fill = "Health Plan Coverage",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

# Render plot
fyc17_18_19x_age_cov_exp.plot

# Build data table
fyc17_18_19x_age_cov_exp.table <- fyc17_18_19x_age_cov_exp.data %>% 
  arrange(SSC_DSC, AGE_GRP_2, INSCOV_DSC, TYPE_DSC) %>% 
  relocate(TYPE_DSC, .after=SSC_DSC) %>% 
  rename(`Standard Error`=se,
         Estimate=est,
         `Marriage Classification`=SSC_DSC,
         `Expenditure Type`=TYPE_DSC,
         `Age Group`=AGE_GRP_2,
         `Health Plan Coverage`=INSCOV_DSC) %>% 
  mutate(rse = `Standard Error`/Estimate,
         rse_flag = case_when(rse > .5 ~ "†", 
                              rse >= .3 & rse <= .5 ~ "*", 
                              T ~ ""),
         `95% CI Lower Bound` = Estimate-1.96*`Standard Error`,
         `95% CI Upper Bound` = Estimate+1.96*`Standard Error`,
         `Relative Standard Error`= paste(scales::percent(`Standard Error`/Estimate), rse_flag)) %>% 
  select(-rse, -rse_flag, -type) %>%  
  kbl(format.args = list(big.mark = ",", digits=3),
      caption = paste0("Data Table for '", fyc17_18_19x_age_cov.title, " ", fyc17_18_19x_age_cov.subtitle, "'")) %>% 
    kable_classic_2(full_width = F, html_font = "Arial") %>% 
    footnote(general = "From MEPS' Precision Standards Guidelines:",
             symbol = c("Estimate can be reported but flagged with an * to indicate that its precision is questionable.", "Estimate should not be reported or displayed in tables due to extremely large sampling error."))

# Render data table
fyc17_18_19x_age_cov_exp.table

```

```{r Exp_Marriage_Class_And_Race_Ethnicity, echo=FALSE}

# Titles:
fyc17_18_19x_age_race_exp.title <- "Estimated Healthcare Expenditures"
fyc17_18_19x_age_race_exp.subtitle <- "By Marriage Classification and Race, Ethnicity"

# Data preproceessing:
fyc17_18_19x_age_race_exp.data <- svyby(~TOTEXPYY+RXEXPYY, by = ~AGE_GRP_2 + RACE_DSC + SSC_DSC, FUN = svymean, design = mepsdsgn) %>% 
  rename("est.TOTEXPYY"="TOTEXPYY",
         "est.RXEXPYY"="RXEXPYY") %>% 
  pivot_longer(ends_with(c("TOTEXPYY","RXEXPYY")),
               names_to = c("measure", "type"),
               names_pattern = "(est|se)\\.(.*)",
               values_to = "value") %>% 
  pivot_wider(names_from = "measure",
              values_from = "value") %>% 
  mutate(TYPE_DSC = if_else(type == "TOTEXPYY", "All Healthcare Expenditures", "RX Expenditures Only"))

# Build plot
fyc17_18_19x_age_race_exp.plot <- fyc17_18_19x_age_race_exp.data %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = RACE_DSC,
                       y = est)) +
  scale_fill_manual(values = custom_palette) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=est-1.96*se, ymax=est+1.96*se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::dollar) +
  facet_grid(TYPE_DSC ~ SSC_DSC, scales="free_y", labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title=fyc17_18_19x_age_race_exp.title,
       subtitle=fyc17_18_19x_age_race_exp.subtitle,
       x = "Age Grouping",
       y = "Individual Healthcare Spend (Survey Weighted)",
       fill = "Race and Ethnicity",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

# Render plot
fyc17_18_19x_age_race_exp.plot

# Build data table
fyc17_18_19x_age_race_exp.table <- fyc17_18_19x_age_race_exp.data %>% 
  arrange(SSC_DSC, AGE_GRP_2, RACE_DSC, TYPE_DSC) %>% 
  rename(`Standard Error`=se,
         Estimate=est,
         `Marriage Classification`=SSC_DSC,
         `Expenditure Type`=TYPE_DSC,
         `Age Group`=AGE_GRP_2,
         `Race & Ethnicity`=RACE_DSC) %>% 
  mutate(rse = `Standard Error`/Estimate,
         rse_flag = case_when(rse > .5 ~ "†", 
                              rse >= .3 & rse <= .5 ~ "*", 
                              T ~ ""),
         `95% CI Lower Bound` = Estimate-1.96*`Standard Error`,
         `95% CI Upper Bound` = Estimate+1.96*`Standard Error`,
         `Relative Standard Error`= paste(scales::percent(`Standard Error`/Estimate), rse_flag)) %>% 
  select(-rse, -rse_flag, -type) %>%  
  kbl(format.args = list(big.mark = ",", digits=3),
      caption = paste0("Data Table for '", fyc17_18_19x_age_race.title, " ", fyc17_18_19x_age_race.subtitle, "'")) %>% 
    kable_classic_2(full_width = F, html_font = "Arial") %>% 
    footnote(general = "From MEPS' Precision Standards Guidelines:",
             symbol = c("Estimate can be reported but flagged with an * to indicate that its precision is questionable.", "Estimate should not be reported or displayed in tables due to extremely large sampling error."))

# Render data table
fyc17_18_19x_age_race_exp.table
```


```{r start-here-Exp_Marriage_Class_And_Race_Ethnicity, echo=FALSE}

fyc18_19x_age_povcat_exp <- svyby(~TOTEXPYY+RXEXPYY, by = ~AGE_GRP_2 + POVCAT_DSC + SSC_DSC, FUN = svymean, design = mepsdsgn) %>% 
  rename("est.TOTEXPYY"="TOTEXPYY",
         "est.RXEXPYY"="RXEXPYY") %>% 
  pivot_longer(ends_with(c("TOTEXPYY","RXEXPYY")),
               names_to = c("measure", "type"),
               names_pattern = "(est|se)\\.(.*)",
               values_to = "value") %>% 
  pivot_wider(names_from = "measure",
              values_from = "value") %>% 
  mutate(TYPE_DSC = if_else(type == "TOTEXPYY", "All Healthcare Expenditures", "RX Expenditures Only"))

fyc18_19x_demo_gg4e <- fyc18_19x_age_povcat_exp %>% 
  mutate(povcat_ordered = fct_relevel(POVCAT_DSC, "High Income", "Middle Income", "Low Income", "Near Poor", "Poor / Negative")) %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = povcat_ordered,
                       y = est)) +
  scale_fill_viridis(discrete=T, begin=0.5, end = 1) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=est-se, ymax=est+se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::dollar) +
  facet_grid(TYPE_DSC ~ SSC_DSC, scales="free_y", labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title="Estimated Healthcare Expenditures",
       subtitle="By Marriage Classification and Income",
       x = "Age Grouping",
       y = "Individual Healthcare Spend (Survey Weighted)",
       fill = "Income Level",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

fyc18_19x_demo_gg4e

```

# Drug Costs are a Large Part of Healthcare Costs for Seniors 

In the 2022 Inflation Reduction Act signed into law by President Biden, [several reforms to the Medicare Part D program](https://www.milliman.com/en/insight/inflation-reduction-act-health-plans-and-part-d-sponsors-need-to-know) are set to be implemented in the coming years. While the overall bill was passed on a party-line vote, the legislated Part D reforms reflect a genuinely bipartisan perception of political urgency around reducing the cost burden of access to low-cost and lifesaving pharmaceutical therapies for seniors, many of whom are living with one or more chronic and behavioral health conditions.

A substantial portion of the total medical expenditures incurred by individuals in retirement are attributable to pharmacy spend, as we are able to see in the visualizations of total healthcare spend above, which include breakout estimates of total individual healthcare spend as well as RX spend alone. Across most socioeconomic strata, racial/ethnicity boundaries, and other demographic classifiers, individuals age 65 and up appear to spend more money on pharmaceutical therapies than their younger counterparts who are in their working years of adulthood.

# Healthcare Expenditures Broken out by Presence of Chronic Conditions

Senior citizens often make use of low-cost generic medications to manage their chronic health conditions such as diabetes, hyperlipidemia (high cholesterol), or hypertension (high blood pressure). Some examples of very common drugs include non-insulin blood glucose reducing agents like [metformin](https://mor.nlm.nih.gov/RxNav/search?searchBy=String&searchTerm=metformin) used for treating Type 2 Diabetes, statins like [atorvastatin](https://mor.nlm.nih.gov/RxNav/search?searchBy=String&searchTerm=atorvastatin) (brand name "Lipitor") used for treating high cholesterol, or ACE inhibitors like [lisinopril](https://mor.nlm.nih.gov/RxNav/search?searchBy=String&searchTerm=lisinopril) (brand names "Prinivil" or "Zestril") to treat hypertension. 

Type 2 diabetes, high cholesterol, and hypertension are three of the leading causes of many other high-cost and potentially avoidable medical complications. Therefore, if senior citizens are able to manage these conditions with regular visits to their primary care providers and by adherence to low-cost drug therapies such as the drugs discussed above, then seniors are less likely to incur potentially avoidable medical costs down the line, which can ultimately help safeguard their their financial security and well-being in retirement.

```{r Exp_Chronic_Cond, echo=F}

fyc18_19x_chronics <- fyc18_19x_flat %>% 
  mutate(ATLEASTONE_CHRONIC = if_else((DIABDX - 1) * (HIBPDX - 1) * (CHOLDX - 1) == 0, "Has been diagnosed with diabetes, hypertension, or hyperlipidemia", "Has not been diagnosed with diabetes, hypertension, or hyperlipidemia")) %>% 
  mutate(RACE_DSC = case_when(RACETHX == 2 ~ "Non-Hispanic White Only",
                              RACETHX != 2 ~ "Other than Non-Hispanic White",
                              T ~ as.character(RACETHX))) 

mepsdsgn_chronics = svydesign(
  id = ~PSU9620,
  strata = ~STRA9620,
  weights = ~POOLWTYY,
  data = fyc18_19x_chronics,
  nest = TRUE)

fyc18_19x_age_ssc_chronics <- svyby(~TOTEXPYY, by = ~AGE_GRP_2 + SSC_DSC + ATLEASTONE_CHRONIC, FUN = svymean, design = mepsdsgn_chronics)

fyc18_19x_age_ssc_chronics_gg <- fyc18_19x_age_ssc_chronics %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = SSC_DSC,
                       y = TOTEXPYY)) +
  scale_fill_viridis(discrete=T, begin=0.5, end = 1) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=TOTEXPYY-se, ymax=TOTEXPYY+se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::dollar) +
  facet_wrap( ~ ATLEASTONE_CHRONIC, ncol=2, labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title="Estimated Healthcare Expenditures by Marriage Classification",
       subtitle="Comparing Married Individuals with and without Chronic Conditions",
       x = "Age Grouping",
       y = "Individual Healthcare Spend (Survey Weighted)",
       fill = "Marriage Classification",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

fyc18_19x_age_ssc_chronics_gg

fyc18_19x_age_race_chronics <- svyby(~TOTEXPYY, by = ~AGE_GRP_2 + RACE_DSC + ATLEASTONE_CHRONIC, FUN = svymean, design = mepsdsgn_chronics)
  
fyc18_19x_age_race_chronics_gg <- fyc18_19x_age_race_chronics %>% 
  ggplot(mapping = aes(x = AGE_GRP_2,
                       fill = RACE_DSC,
                       y = TOTEXPYY)) +
  scale_fill_viridis(discrete=T, begin=0.5, end = 1) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=TOTEXPYY-se, ymax=TOTEXPYY+se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::dollar) +
  facet_wrap( ~ ATLEASTONE_CHRONIC, ncol=2, labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title="Estimated Healthcare Expenditures by Race, Ethnicity",
       subtitle="Comparing Married Individuals with and without Chronic Conditions",
       x = "Age Grouping",
       y = "Individual Healthcare Spend (Survey Weighted)",
       fill = "Race and Ethnicity",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

fyc18_19x_age_race_chronics_gg

```

The two charts above present a comparison that show differences in individual healthcare expenditures amongst individuals who have been diagnosed with potentially high-cost chronic conditions. Due to the fact that further stratifying the data presents an obligation to display a wider error bar on the plots, I have tried to minimally stratify the data to yield plots with error bars that allow the reader to access meaningful conclusions about disparities explored.

In the first comparison of married individuals with and without chronic conditions that can lead to potentially high-cost chronic conditions, it is difficult to discern any meaningful difference between the magnitude of individual healthcare expenditures incurred between married individuals in same-sex marriages and married individuals not in same-sex marriages. This visualization does seem to hint at what is already known about the disparities in healthcare costs between members with chronic conditions such as diabetes, hypertension, or hyperlipidemia.

The second comparison is presented in order to show that there is likely a statistically significant disparity in individual healthcare spend across race and ethnicity distinctions, when broken out across age groups as well as chronic disease status. Naturally, the statistical significance depends on the analyst's selection of p-value threshold, but it is fairly uncontroversial to state that non-Hispanic white individuals tend to have a greater individual healthcare spend spend than individuals who identify as other than non-Hispanic white. The reasons for this disparity, whether due to systemic issues inhibiting access to healthcare services for some populations or some other reason are the subject of ample research initiatives and not further discussed here. 

However it is important to note, again, that when exploring disparities in access to preventative healthcare services across LGBTQ+ and non-LGBTQ+ populations, an intersectional lens is required. Owing to the small sample size of individuals in same-sex marriages in the MEPS data, it is difficult to explore the issue further without veering into the realm of "data torture."

# Family Size Can Impact Healthcare Outcomes for Seniors

One feature that can drive the total cost of care at the individual level is family size. Larger families within the same dwelling unit can help take care of one another when sick, coordinate transportation to and from sites where healthcare is provided, manage childcare duties so that adults are able to arrange for healthcare services, and so on. Several studies have shown a linkage between medication adherence and family size, particularly among families in low-income socioeconomic strata.

For a number of reasons not discussed further here, the family size of families that include individuals within same-sex marriages is likely to be smaller than that of their counterparts in marriages not regarded as same-sex. As such, it is worth exploring how family size can impact the total individual healthcare spend across age groups.


```{r Exp_Vs_FamSize, echo=F}

fyc18_19x_age_famsize_exp <- svyby(~TOTEXPYY, by = ~ SSC_DSC + FAMSZEYR_GRP + AGE_GRP_2, FUN = svymean, design = mepsdsgn)

fyc18_19x_age_famsize_exp_gg1 <- fyc18_19x_age_famsize_exp %>% 
  ggplot(mapping = aes(x = forcats::as_factor(FAMSZEYR_GRP),
                       fill = SSC_DSC,
                       y = TOTEXPYY)) +
  scale_fill_viridis(discrete=T, begin=0.5, end = 1) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=TOTEXPYY-se, ymax=TOTEXPYY+se), width=.2,
                position=position_dodge(.9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::dollar) +
  facet_wrap(AGE_GRP_2 ~ ., nrow = 2, labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  labs(title="Estimated Healthcare Expenditures Per Individual",
       subtitle="By Marriage Classification and Family Size",
       x = "Family Size",
       y = "Individual Healthcare Spend (Survey Weighted)",
       fill = "Marriage Classification",
       caption = "MEPS 2017 - 2019 Pooled Full Year Consolidated Data Files\n(https://meps.ahrq.gov/)") +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3))

fyc18_19x_age_famsize_exp_gg1



```


# Conclusion

Due to the lack of data currently available that describes the healthcare experiences specific to LGBTQ+ populations, we must continue to be creative about how we source information that helps build policy and products to better strengthen the lives of LGBTQ+ individuals who are currently enjoying retirement, as well as those who will be retiring soon.

While we’ve only just skimmed the surface of what MEPS has to offer, MEPS provides an excellent cross section of data collected in a well-designed survey framework that can aid key decision makers as they go about analyzing the impacts that Social Determinants of Health have on retirement-related outcomes. 

Some examples of other potentially interesting variables in the context of examining retirement-related outcomes alongside the ones I’ve shown in this paper include:

```
MILDIF31        DIFFICULTY WALKING A MILE - RD 3/1 
MIAGED          AGE OF DIAGNOSIS-HEART ATTACK(MI) 
WHTLGSPK        WHAT LANGUAGE SPOKEN OTHER THAN ENGLISH 
DDNWRK19        # DAYS MISSED WORK DUE TO ILL/INJ 2019 
ADRESP42        SAQ 12 MOS: DR SHOWED RESPECT 
PROBPY42        FAMILY HAVING PROB PAYING MEDICAL BILLS 
```

And while the particular method I’ve demonstrated in this paper for identifying LGBTQ+ individuals and experiences certainly does have its flaws, we have to do the best we can with the information we have – and publicly available data on the needs of LGBTQ+ individuals at or near retirement age is, at times, frustratingly scarce.

Finally, this sort of work encourages discussions that broaden our understanding of how systemic disparities act with intersectionality among other groups and subpopulations. And while understanding the concept of intersectionality is one thing, being able to quantify the result of intersectional disparate outcomes, even if the data isn’t perfect, is entirely more useful.


